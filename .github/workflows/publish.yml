name: Publish to GitHub Packages

on:
  push:
    branches:
      - develop

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: changesets
        run: |
          # Check if there are any changeset files (excluding README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')
          echo "count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          if [ "$CHANGESET_COUNT" -gt "0" ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "Found $CHANGESET_COUNT changeset(s) to process"
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "No changesets found, skipping publish workflow"
          fi

      - name: Setup Bun
        if: steps.changesets.outputs.has_changesets == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.changesets.outputs.has_changesets == 'true'
        run: bun install --frozen-lockfile

      - name: Run tests
        if: steps.changesets.outputs.has_changesets == 'true'
        run: bun run test

      - name: Build package
        if: steps.changesets.outputs.has_changesets == 'true'
        run: bun run build

      - name: Configure Git
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Version packages
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          bun run changeset version
          # Get the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit version bump
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          git add .
          git commit -m "chore: release v${{ env.NEW_VERSION }}" || echo "No changes to commit"
          git push

      - name: Create and push git tag
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          git tag "v${{ env.NEW_VERSION }}"
          git push origin "v${{ env.NEW_VERSION }}"

      - name: Setup Node.js for npm publish
        if: steps.changesets.outputs.has_changesets == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: Publish to GitHub Packages
        if: steps.changesets.outputs.has_changesets == 'true'
        run: npm publish --registry=https://npm.pkg.github.com
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build standalone executables
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          mkdir -p release-binaries
          
          # Build for Linux x64
          bun build ./src/cli.ts --compile --target=bun-linux-x64 --outfile ./release-binaries/branch-narrator-linux-x64
          
          # Build for Linux ARM64
          bun build ./src/cli.ts --compile --target=bun-linux-arm64 --outfile ./release-binaries/branch-narrator-linux-arm64
          
          # Build for macOS x64
          bun build ./src/cli.ts --compile --target=bun-darwin-x64 --outfile ./release-binaries/branch-narrator-darwin-x64
          
          # Build for macOS ARM64 (Apple Silicon)
          bun build ./src/cli.ts --compile --target=bun-darwin-arm64 --outfile ./release-binaries/branch-narrator-darwin-arm64
          
          # Build for Windows x64
          bun build ./src/cli.ts --compile --target=bun-windows-x64 --outfile ./release-binaries/branch-narrator-windows-x64.exe
          
          # Create archives
          cd release-binaries
          for f in branch-narrator-linux-* branch-narrator-darwin-*; do
            if [ -f "$f" ]; then
              chmod +x "$f"
              tar -czvf "${f}.tar.gz" "$f"
            fi
          done
          if [ -f "branch-narrator-windows-x64.exe" ]; then
            zip branch-narrator-windows-x64.zip branch-narrator-windows-x64.exe
          fi

      - name: Create GitHub Release
        if: steps.changesets.outputs.has_changesets == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          generate_release_notes: true
          files: |
            release-binaries/*.tar.gz
            release-binaries/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
